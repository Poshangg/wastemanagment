<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collector Dashboard - G-TRUCKS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Add Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/collector.css') }}">
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f8f9fa;
        }
        
        .location-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #198754;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
            }
            
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
            }
            
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
            }
        }
        
        .collector-status {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #198754;
            background-color: #f8f9fa;
            margin-bottom: 1rem;
        }
        
        .task-card {
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .task-card.completed {
            opacity: 0.7;
        }
        
        .task-card.active {
            border-left: 4px solid #198754;
        }
        
        .task-card.pending {
            border-left: 4px solid #0d6efd;
        }
        
        #map {
            height: 300px;
            border-radius: 0.5rem;
        }
        
        .footer {
            margin-top: auto;
        }

        /* Custom marker styles */
        .custom-truck-marker {
            background-color: transparent;
            border: none;
        }
        
        .truck-icon-container {
            position: relative;
        }
        
        .truck-icon-pulse {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(25, 135, 84, 0.3);
            z-index: -1;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: marker-pulse 2s infinite;
        }
        
        @keyframes marker-pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
        
        /* Destination marker styling */
        .destination-marker {
            background-color: transparent;
            border: none;
        }
        
        .destination-container {
            position: relative;
            text-align: center;
        }
        
        .destination-icon {
            position: relative;
            z-index: 2;
        }
        
        .destination-pulse {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(220, 53, 69, 0.3);
            z-index: 1;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: destination-pulse 2s infinite;
        }
        
        @keyframes destination-pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
        
        .map-legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }
        
        .map-legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .map-legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 3px;
        }

        /* Custom truck icon styling */
        .truck-icon {
            background-color: #198754;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 0 0 3px white, 0 0 10px rgba(0,0,0,0.5);
            transform: translateY(-5px); /* Adjust for icon position */
        }

        /* Avatar map marker styling */
        .avatar-marker-container {
            position: relative;
        }
        
        .avatar-marker-pulse {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(25, 135, 84, 0.3);
            z-index: -1;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: marker-pulse 2s infinite;
        }
        
        .avatar-marker {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid #198754;
            background-color: white;
            object-fit: cover;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        
        .collector-popup {
            text-align: center;
        }
        
        .collector-popup img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #198754;
            object-fit: cover;
            margin-bottom: 8px;
        }
        
        .collector-popup h4 {
            margin: 5px 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .collector-popup .details {
            margin-bottom: 5px;
            font-size: 14px;
        }

        /* Navigation panel styles */
        .route-instructions {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
        }
        
        .instruction-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .instruction-item:last-child {
            border-bottom: none;
        }
        
        .instruction-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .instruction-distance {
            font-size: 0.75rem;
            color: #6c757d;
            margin-left: auto;
        }
        
        /* Hide default OSRM container but keep functionality */
        .leaflet-routing-container {
            display: none;
        }

        /* Styling for notification badge */
        .notification-badge {
            position: absolute;
            top: 10px;
            right: 5px;
            font-size: 0.65em;
            padding: 0.25em 0.4em;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('collector_dashboard') }}">
                <img src="{{ url_for('static', filename='img/wastelogo.webp') }}" alt="G-TRUCKS Logo" height="40">
                G-TRUCKS Collector
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('collector_dashboard') }}">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('collector_schedules') }}">My Schedules</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('collector_reports') }}">Reports</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown position-relative">
                        <a class="nav-link dropdown-toggle" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-bell"></i>
                            {% if notifications and notifications|length > 0 %}
                                <span class="badge bg-danger notification-badge rounded-pill">{{ notifications|length }}</span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationsDropdown">
                            <li><h6 class="dropdown-header">Notifications</h6></li>
                            {% if notifications %}
                                {% for notification in notifications[:5] %} {# Show recent 5 notifications #}
                                    <li><a class="dropdown-item" href="#">
                                        <small>{{ notification.message }}</small><br>
                                        <small class="text-muted">{{ notification.created_at.strftime('%b %d, %I:%M %p') }}</small>
                                    </a></li>
                                {% endfor %}
                            {% else %}
                                <li><span class="dropdown-item text-muted">No new notifications</span></li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-center" href="#">View all notifications</a></li> {# Link to a full notifications page if available #}
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            {% if avatar_path %}
                                <img src="{{ url_for('static', filename='uploads/avatars/' + avatar_path) }}?v={{ now }}" 
                                     alt="{{ current_user.username }}" 
                                     class="rounded-circle me-1" 
                                     style="width: 24px; height: 24px; object-fit: cover;"
                                     onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/avatar-default.png') }}'; this.style.display='none'; document.getElementById('collectorFallbackIcon').style.display='inline-block';">
                                <i id="collectorFallbackIcon" class="bi bi-person-circle" style="display: none;"></i>
                            {% else %}
                                <i class="bi bi-person-circle"></i>
                            {% endif %}
                            {{ current_user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('collector_profile') }}">Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 class="mb-4">Welcome, {{ collector.user.username }}!</h2>
                
                <div class="collector-status d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">Status: 
                            {% if collector.is_active %}
                                <span class="text-success">Active</span>
                            {% else %}
                                <span class="text-danger">Inactive</span>
                            {% endif %}
                        </h5>
                        <p class="mb-0">Vehicle ID: {{ collector.vehicle_id }}</p>
                        <p class="mb-0">Assigned to {{ collector.assigned_barangay.name }} (District {{ collector.assigned_barangay.district }})</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="statusToggle" {{ 'checked' if collector.is_active else '' }}>
                        <label class="form-check-label" for="statusToggle">Enable Location Sharing</label>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-geo-alt"></i> Your Current Location</h5>
                    </div>
                    <div class="card-body">
                        <div id="map" class="mb-3"></div>
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <span class="location-indicator"></span>
                                <span id="locationStatus">Updating your location...</span>
                            </div>
                            <div id="destinationInfo" style="display: none;">
                                <span class="badge bg-danger">Destination:</span>
                                <span id="destinationName">Not set</span>
                                <span id="destinationEta" class="ms-2 fw-bold"></span>
                            </div>
                        </div>
                        <div id="route-instructions-container" class="route-instructions mt-3" style="display: none;">
                            <div id="route-instructions-list"></div>
                        </div>
                        <div class="mt-3 d-flex flex-wrap gap-2">
                            <button id="refreshLocation" class="btn btn-primary">
                                <i class="bi bi-arrow-clockwise"></i> Refresh Location
                            </button>
                            <button id="setDestination" class="btn btn-outline-danger">
                                <i class="bi bi-pin-map"></i> Set Destination
                            </button>
                            <button id="clearDestination" class="btn btn-outline-secondary" style="display: none;">
                                <i class="bi bi-x-circle"></i> Clear Destination
                            </button>
                            <!-- Add navigation controls -->
                            <button id="startNavigation" class="btn btn-success" style="display: none;">
                                <i class="bi bi-play-fill"></i> Start Navigation
                            </button>
                            <button id="pauseNavigation" class="btn btn-warning" style="display: none;">
                                <i class="bi bi-pause-fill"></i> Pause
                            </button>
                            <button id="stopNavigation" class="btn btn-danger" style="display: none;">
                                <i class="bi bi-stop-fill"></i> Stop
                            </button>
                            <button id="reportIssue" class="btn btn-outline-warning">
                                <i class="bi bi-exclamation-triangle"></i> Report Issue
                            </button>
                        </div>
                        <!-- Add navigation progress bar -->
                        <div id="navigationProgress" class="mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small id="routeProgressText">Progress: 0%</small>
                                <small id="routeRemainingTime">Remaining: calculating...</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" id="routeProgressBar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h4 class="mb-3">Today's Collection Tasks</h4>
                
                {% if schedules %}
                    {% for schedule in schedules %}
                        <div class="card task-card {{ 'completed' if schedule.status == 'completed' else ('active' if schedule.status == 'in-progress' else 'pending') }}" data-id="{{ schedule.id }}" onclick="navigateToTask('{{ schedule.id }}', '{{ schedule.barangay.name }}')">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="card-title">{{ schedule.barangay.name }}</h5>
                                    <span class="badge {{ 'bg-success' if schedule.status == 'completed' else ('bg-warning' if schedule.status == 'in-progress' else 'bg-primary') }}">
                                        {{ schedule.status|capitalize }}
                                    </span>
                                </div>
                                <p class="card-text">
                                    <i class="bi bi-clock"></i> {{ schedule.time_start.strftime('%I:%M %p') }} - {{ schedule.time_end.strftime('%I:%M %p') }}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        {% if schedule.status == 'scheduled' %}
                                            <button class="btn btn-sm btn-outline-primary start-task" data-id="{{ schedule.id }}" onclick="event.stopPropagation();">
                                                <i class="bi bi-play-fill"></i> Start
                                            </button>
                                        {% elif schedule.status == 'in-progress' %}
                                            <button class="btn btn-sm btn-outline-success complete-task" data-id="{{ schedule.id }}" onclick="event.stopPropagation();">
                                                <i class="bi bi-check2"></i> Complete
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger pause-task" data-id="{{ schedule.id }}" onclick="event.stopPropagation();">
                                                <i class="bi bi-pause-fill"></i> Pause
                                            </button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-secondary" disabled onclick="event.stopPropagation();">
                                                <i class="bi bi-check2-all"></i> Completed
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-info navigate-to-task" onclick="event.stopPropagation(); navigateToTask('{{ schedule.id }}', '{{ schedule.barangay.name }}');">
                                            <i class="bi bi-map"></i> Navigate
                                        </button>
                                    </div>
                                    <small class="text-muted">Est. duration: 2 hours</small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> You have no collection tasks scheduled for today.
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-speedometer2"></i> Performance Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6>Collection Efficiency</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 85%;" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100">85%</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>On-Time Performance</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 92%;" aria-valuenow="92" aria-valuemin="0" aria-valuemax="100">92%</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>Resident Satisfaction</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 89%;" aria-valuenow="89" aria-valuemin="0" aria-valuemax="100">89%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-calendar3"></i> Upcoming Schedule</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            {% for i in range(5) %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="mb-0">{{ ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'][i] }}</h6>
                                            <small class="text-muted">9:00 AM - 11:30 AM</small>
                                        </div>
                                        <span class="badge bg-primary">Scheduled</span>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="card-footer text-center">
                        <a href="{{ url_for('collector_schedules') }}" class="btn btn-sm btn-outline-primary">View All Schedules</a>
                    </div>
                </div>

                <!-- Recent Notifications Card -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0"><i class="bi bi-bell-fill"></i> Recent Notifications</h5>
                        <a href="#" class="text-decoration-none small">View all</a> {# Link to a full notifications page #}
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            {% if notifications and notifications|length > 0 %}
                                {% for notification in notifications[:5] %} {# Display up to 5 recent notifications #}
                                    <li class="list-group-item">
                                        <div class="d-flex">
                                            <div class="me-3 pt-1">
                                                <i class="bi bi-info-circle text-primary"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0 small">{{ notification.message }}</p>
                                                <small class="text-muted">{{ notification.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            {% else %}
                                <li class="list-group-item text-center py-3">
                                    <i class="bi bi-bell-slash fs-4 text-muted mb-2"></i>
                                    <p class="mb-0 text-muted small">No new notifications</p>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-chat-left-text"></i> Resident Feedback</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star text-warning"></i>
                                    </div>
                                    <div>
                                        <p class="mb-0">Very prompt and efficient service!</p>
                                        <small class="text-muted">- Resident from {{ collector.assigned_barangay.name }}</small>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                    </div>
                                    <div>
                                        <p class="mb-0">Always on time and very thorough!</p>
                                        <small class="text-muted">- Resident from {{ collector.assigned_barangay.name }}</small>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Issue Modal -->
    <div class="modal fade" id="reportIssueModal" tabindex="-1" aria-labelledby="reportIssueModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportIssueModalLabel">Report an Issue</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="issueForm">
                        <div class="mb-3">
                            <label for="issueType" class="form-label">Issue Type</label>
                            <select class="form-select" id="issueType" required>
                                <option value="" selected disabled>Select issue type</option>
                                <option value="vehicle">Vehicle Problem</option>
                                <option value="road">Road Blockage</option>
                                <option value="weather">Bad Weather</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="issueDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="issueDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="estimatedDelay" class="form-label">Estimated Delay</label>
                            <select class="form-select" id="estimatedDelay">
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="120">2+ hours</option>
                                <option value="cancel">Need to reschedule</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitIssue">Submit Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Set Destination Modal -->
    <div class="modal fade" id="setDestinationModal" tabindex="-1" aria-labelledby="setDestinationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="setDestinationModalLabel">Set Destination</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="destinationForm">
                        <div class="mb-3">
                            <label for="destinationAddress" class="form-label">Destination Address or Location</label>
                            <input type="text" class="form-control" id="destinationAddress" placeholder="Enter address or location name" required>
                        </div>
                        <div class="mb-3">
                            <label for="destinationType" class="form-label">Destination Type</label>
                            <select class="form-select" id="destinationType" required>
                                <option value="collection">Collection Point</option>
                                <option value="dumping">Dumping Site</option>
                                <option value="refuel">Refueling Station</option>
                                <option value="maintenance">Maintenance Facility</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="estimatedArrival" class="form-label">Estimated Time of Arrival</label>
                            <input type="time" class="form-control" id="estimatedArrival">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveDestination">Save Destination</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>G-TRUCKS</h5>
                    <p>Smart waste collection for a cleaner community.</p>
                </div>
                <div class="col-md-3">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="{{ url_for('collector_dashboard') }}" class="text-white">Dashboard</a></li>
                        <li><a href="{{ url_for('collector_schedules') }}" class="text-white">My Schedules</a></li>
                        <li><a href="{{ url_for('collector_reports') }}" class="text-white">Reports</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Support</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white">Contact Admin</a></li>
                        <li><a href="#" class="text-white">Help Guide</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <p>&copy; 2023 G-TRUCKS. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Add Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([14.676, 121.043], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add map legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'map-legend');
            div.innerHTML = `
                <div class="map-legend-item">
                    <div class="map-legend-color bg-success"></div>
                    <span>Your Truck</span>
                </div>
                <div class="map-legend-item">
                    <div class="map-legend-color bg-danger"></div>
                    <span>Destination</span>
                </div>
                <div class="map-legend-item">
                    <div class="map-legend-color" style="background-color: #3388ff;"></div>
                    <span>Route</span>
                </div>
            `;
            return div;
        };
        legend.addTo(map);

        // Current location marker
        let currentLocationMarker;
        let watchId;

        // Destination marker and route line
        let destinationMarker = null;
        let routeLine = null;

        // Variables for routing
        let routeControl = null;
        let routeInstructions = [];
        let routeCoordinates = [];
        let currentRouteIndex = 0;
        let isNavigating = false;
        let navigationInterval = null;
        let navigationSpeed = 30; // km/h - speed for navigation simulation

        // Start or stop location tracking based on toggle
        document.getElementById('statusToggle').addEventListener('change', function() {
            if (this.checked) {
                // Enable location tracking
                startTracking();
                fetch('/api/collector/set-active', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ active: true })
                });
            } else {
                // Disable location tracking
                stopTracking();
                fetch('/api/collector/set-active', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ active: false })
                });
            }
        });

        function startTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    updateLocation,
                    locationError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
                document.getElementById('locationStatus').textContent = 'Location sharing is active';
                document.getElementById('locationStatus').className = 'text-success';
            } else {
                alert('Geolocation is not supported by this browser.');
                document.getElementById('statusToggle').checked = false;
            }
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            document.getElementById('locationStatus').textContent = 'Location sharing is disabled';
            document.getElementById('locationStatus').className = 'text-danger';
        }

        function updateLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Update marker on map
            if (currentLocationMarker) {
                currentLocationMarker.setLatLng([lat, lng]);
                
                // Update route if destination is set
                if (destinationMarker) {
                    updateRoute();
                }
            } else {
                // Debug avatar path to console
                console.log("Avatar path from template:", "{{ avatar_path|default('none') }}");
                
                // Get avatar URL with fallback
                let avatarUrl;
                {% if avatar_path %}
                    avatarUrl = "{{ url_for('static', filename='uploads/avatars/' + avatar_path) }}?v={{ now }}";
                    console.log("Using avatar from path:", avatarUrl);
                {% else %}
                    avatarUrl = "{{ url_for('static', filename='img/avatar-default.png') }}";
                    console.log("No avatar path available, using default");
                {% endif %}
                
                // Create a custom icon with collector's avatar
                const collectorIcon = L.divIcon({
                    className: 'custom-avatar-marker',
                    html: `
                        <div class="avatar-marker-container">
                            <div class="avatar-marker-pulse"></div>
                            <img src="${avatarUrl}" 
                                 class="avatar-marker" 
                                 alt="Collector" 
                                 onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/avatar-default.png') }}'; console.log('Avatar load failed, using default');">
                        </div>
                    `,
                    iconSize: [45, 45],
                    iconAnchor: [22, 22],
                    popupAnchor: [0, -25]
                });
                
                currentLocationMarker = L.marker([lat, lng], {icon: collectorIcon}).addTo(map);
                
                // Add a richer popup with collector details
                currentLocationMarker.bindPopup(`
                    <div class="collector-popup">
                        <img src="${avatarUrl}" 
                             alt="Collector" 
                             onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/avatar-default.png') }}';">
                        <h4>{{ current_user.username }}</h4>
                        <div class="details">
                            <strong>Vehicle ID:</strong> {{ collector.vehicle_id }}<br>
                            <strong>Area:</strong> {{ collector.assigned_barangay.name }}<br>
                            <strong>Status:</strong> <span class="badge bg-success">Active</span>
                        </div>
                        <small>Last updated: <span id="popup-timestamp">${new Date().toLocaleTimeString()}</span></small>
                    </div>
                `);
                
                map.setView([lat, lng], 15);
            }
            
            // Update the popup timestamp if opened
            const popupTimestamp = document.getElementById('popup-timestamp');
            if (popupTimestamp) {
                popupTimestamp.textContent = new Date().toLocaleTimeString();
            }
            
            // Send location to server
            fetch('/api/collector/update-location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    lat: lat, 
                    lng: lng, 
                    timestamp: new Date().toISOString()
                })
            });
            
            document.getElementById('locationStatus').textContent = 'Location updated at ' + new Date().toLocaleTimeString();
        }

        function locationError(error) {
            console.error('Error getting location:', error);
            document.getElementById('locationStatus').textContent = 'Error: ' + error.message;
            document.getElementById('locationStatus').className = 'text-danger';
        }

        // Refresh location button
        document.getElementById('refreshLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(updateLocation, locationError);
            }
        });

        // Report issue button
        document.getElementById('reportIssue').addEventListener('click', function() {
            const reportModal = new bootstrap.Modal(document.getElementById('reportIssueModal'));
            reportModal.show();
        });

        // Submit issue form
        document.getElementById('submitIssue').addEventListener('click', function() {
            const issueType = document.getElementById('issueType').value;
            const issueDescription = document.getElementById('issueDescription').value;
            const estimatedDelay = document.getElementById('estimatedDelay').value;
            
            if (!issueType || !issueDescription) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Send issue report to server
            fetch('/api/collector/report-issue', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: issueType,
                    description: issueDescription,
                    estimated_delay: estimatedDelay
                })
            })
            .then(response => response.json())
            .then(data => {
                const reportModal = bootstrap.Modal.getInstance(document.getElementById('reportIssueModal'));
                reportModal.hide();
                alert('Issue reported successfully');
            })
            .catch(error => {
                console.error('Error reporting issue:', error);
                alert('Failed to report issue. Please try again.');
            });
        });

        // Task management buttons
        document.querySelectorAll('.start-task').forEach(button => {
            button.addEventListener('click', function() {
                const scheduleId = this.getAttribute('data-id');
                updateTaskStatus(scheduleId, 'in-progress');
            });
        });

        document.querySelectorAll('.complete-task').forEach(button => {
            button.addEventListener('click', function() {
                const scheduleId = this.getAttribute('data-id');
                updateTaskStatus(scheduleId, 'completed');
            });
        });

        function updateTaskStatus(scheduleId, status) {
            fetch('/api/collector/update-schedule-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    schedule_id: scheduleId,
                    status: status
                })
            })
            .then(response => response.json())
            .then(data => {
                // Reload page to reflect changes
                location.reload();
            })
            .catch(error => {
                console.error('Error updating task status:', error);
                alert('Failed to update task status. Please try again.');
            });
        }

        // Function to set destination
        function setDestination(lat, lng, name) {
            // Stop any ongoing navigation
            stopNavigation();
            
            // Create custom destination icon
            const destinationIcon = L.divIcon({
                className: 'destination-marker',
                html: `
                    <div class="destination-container">
                        <div class="destination-pulse"></div>
                        <div class="destination-icon">
                            <i class="bi bi-geo-alt-fill fs-3 text-danger"></i>
                        </div>
                    </div>
                `,
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -30]
            });
            
            // Remove existing destination if any
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
            }
            
            // Add new destination marker
            destinationMarker = L.marker([lat, lng], {icon: destinationIcon}).addTo(map);
            destinationMarker.bindPopup(`<strong>Destination:</strong><br>${name || 'Unknown location'}`);
            
            // Show destination info
            document.getElementById('destinationInfo').style.display = 'block';
            document.getElementById('destinationName').textContent = name || 'Set destination';
            document.getElementById('clearDestination').style.display = 'inline-block';
            
            // Update the route
            updateRoute();
            
            // Fit map to show both current location and destination
            if (currentLocationMarker) {
                const bounds = L.latLngBounds(
                    currentLocationMarker.getLatLng(),
                    destinationMarker.getLatLng()
                );
                map.fitBounds(bounds, {padding: [50, 50]});
            }
        }
        
        // Function to update the route line with proper navigation
        function updateRoute() {
            if (!currentLocationMarker || !destinationMarker) return;
            
            const start = currentLocationMarker.getLatLng();
            const end = destinationMarker.getLatLng();
            
            // Remove existing route if any
            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }
            
            // Create a new route using Leaflet Routing Machine
            routeControl = L.Routing.control({
                waypoints: [
                    L.latLng(start.lat, start.lng),
                    L.latLng(end.lat, end.lng)
                ],
                routeWhileDragging: false,
                addWaypoints: false,
                createMarker: function() { return null; }, // Don't create markers, we already have them
                lineOptions: {
                    styles: [
                        {color: '#3388ff', opacity: 0.8, weight: 5},
                        {color: 'white', opacity: 0.3, weight: 8}
                    ]
                },
                show: false // Don't show the default instructions panel
            }).addTo(map);
            
            // Listen for route found event to get instructions
            routeControl.on('routesfound', function(e) {
                const routes = e.routes;
                const route = routes[0]; // Get the first route
                
                // Store route coordinates for navigation simulation
                routeCoordinates = route.coordinates || [];
                console.log("Route found with", routeCoordinates.length, "coordinates");
                currentRouteIndex = 0;
                
                // Calculate ETA
                const distanceInMeters = route.summary.totalDistance;
                const distanceText = distanceInMeters > 1000 ? 
                    `${(distanceInMeters / 1000).toFixed(1)} km` : 
                    `${Math.round(distanceInMeters)} m`;
                
                const timeInSeconds = route.summary.totalTime;
                const timeInMinutes = Math.round(timeInSeconds / 60);
                const etaText = timeInMinutes > 60 ? 
                    `${Math.floor(timeInMinutes / 60)} hr ${timeInMinutes % 60} min` : 
                    `${timeInMinutes} min`;
                
                document.getElementById('destinationEta').textContent = `${distanceText} (ETA: ${etaText})`;
                
                // Extract and display turn-by-turn instructions
                const instructions = route.instructions || [];
                displayRouteInstructions(instructions);
                
                // Show navigation button once route is calculated
                document.getElementById('startNavigation').style.display = 'inline-block';
            });
        }
        
        // Function to display turn-by-turn instructions
        function displayRouteInstructions(instructions) {
            const container = document.getElementById('route-instructions-list');
            if (!container) return;
            
            // Clear previous instructions
            container.innerHTML = '';
            
            // Show the container
            document.getElementById('route-instructions-container').style.display = 'block';
            
            if (!instructions || instructions.length === 0) {
                container.innerHTML = '<div class="instruction-item">No navigation instructions available.</div>';
                return;
            }
            
            // Create elements for each instruction
            instructions.forEach((instruction, index) => {
                // Skip the last "arrive at destination" instruction if we have more than one
                if (index === instructions.length - 1 && instructions.length > 1 && instruction.type === 'DestinationReached') {
                    return;
                }
                
                const item = document.createElement('div');
                item.className = 'instruction-item';
                
                // Get direction icon
                const icon = getDirectionIcon(instruction.type);
                
                // Format distance
                const distance = instruction.distance ? 
                    (instruction.distance > 1000 ? 
                        `${(instruction.distance / 1000).toFixed(1)} km` : 
                        `${Math.round(instruction.distance)} m`) : 
                    '';
                
                item.innerHTML = `
                    <div class="instruction-icon">${icon}</div>
                    <div class="instruction-text">${instruction.text}</div>
                    <div class="instruction-distance">${distance}</div>
                `;
                
                container.appendChild(item);
            });
        }
        
        // Function to get appropriate icon for direction
        function getDirectionIcon(type) {
            switch (type) {
                case 'StartAt':
                    return '<i class="bi bi-signpost-fill"></i>';
                case 'WaypointReached':
                case 'DestinationReached':  
                    return '<i class="bi bi-geo-alt-fill"></i>';
                case 'TurnRight':
                    return '<i class="bi bi-arrow-right"></i>';
                case 'TurnLeft':
                    return '<i class="bi bi-arrow-left"></i>';
                case 'TurnSharpRight':
                    return '<i class="bi bi-arrow-90deg-right"></i>';
                case 'TurnSharpLeft':
                    return '<i class="bi bi-arrow-90deg-left"></i>';
                case 'TurnSlightRight':
                    return '<i class="bi bi-arrow-up-right"></i>';
                case 'TurnSlightLeft':
                    return '<i class="bi bi-arrow-up-left"></i>';
                case 'GoStraight':
                    return '<i class="bi bi-arrow-up"></i>';
                default:
                    return '<i class="bi bi-arrow-up"></i>';
            }
        }
        
        // Clear destination with updated function to clear navigation
        function clearDestination() {
            // Stop navigation if it's running
            stopNavigation();
            currentRouteIndex = 0;
            routeCoordinates = [];
            
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }
            
            document.getElementById('destinationInfo').style.display = 'none';
            document.getElementById('clearDestination').style.display = 'none';
            document.getElementById('route-instructions-container').style.display = 'none';
            document.getElementById('startNavigation').style.display = 'none';
        }
        
        // Begin navigation along the route
        function startNavigation() {
            if (!routeCoordinates || routeCoordinates.length < 2) {
                console.error("No route coordinates available for navigation");
                return;
            }
            
            if (isNavigating) {
                console.log("Already navigating");
                return;
            }
            
            console.log("Starting navigation with", routeCoordinates.length, "points");
            isNavigating = true;
            document.getElementById('startNavigation').style.display = 'none';
            document.getElementById('pauseNavigation').style.display = 'inline-block';
            document.getElementById('stopNavigation').style.display = 'inline-block';
            document.getElementById('navigationProgress').style.display = 'block';
            
            // Disable location watching during simulation
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Reset index to start from beginning
            currentRouteIndex = 0;
            
            // Define the movement function
            const simulateTruckMovement = () => {
                if (currentRouteIndex >= routeCoordinates.length - 1) {
                    console.log("Navigation complete - Arrived at destination");
                    
                    // Keep the truck at the destination instead of stopping navigation
                    isNavigating = false;
                    if (navigationInterval) {
                        clearTimeout(navigationInterval);
                        navigationInterval = null;
                    }
                    
                    // Update UI to show arrival
                    document.getElementById('routeProgressText').textContent = 'Arrived at destination!';
                    document.getElementById('routeRemainingTime').textContent = '';
                    document.getElementById('routeProgressBar').style.width = '100%';
                    document.getElementById('routeProgressBar').setAttribute('aria-valuenow', 100);
                    
                    // Change button states
                    document.getElementById('startNavigation').style.display = 'none';
                    document.getElementById('pauseNavigation').style.display = 'none';
                    document.getElementById('stopNavigation').style.display = 'inline-block';
                    
                    // Show arrival notification
                    showArrivalNotification();
                    
                    // If there's an active task linked to this destination, update its UI
                    updateActiveTaskStatus();
                    
                    return;
                }
                
                const currentPoint = routeCoordinates[currentRouteIndex];
                const nextPoint = routeCoordinates[currentRouteIndex + 1];
                
                console.log(`Moving from point ${currentRouteIndex} to ${currentRouteIndex + 1}`);
                
                // Update truck marker position
                if (currentLocationMarker) {
                    currentLocationMarker.setLatLng([currentPoint.lat, currentPoint.lng]);
                    
                    // Center map on truck during navigation with slight offset for better view
                    map.panTo([
                        currentPoint.lat, 
                        currentPoint.lng
                    ]);
                    
                    // Calculate progress percentage
                    const progressPercent = Math.min(Math.round((currentRouteIndex / (routeCoordinates.length - 1)) * 100), 100);
                    document.getElementById('routeProgressText').textContent = `Progress: ${progressPercent}%`;
                    document.getElementById('routeProgressBar').style.width = `${progressPercent}%`;
                    document.getElementById('routeProgressBar').setAttribute('aria-valuenow', progressPercent);
                    
                    // Calculate remaining time
                    const remainingPoints = routeCoordinates.length - currentRouteIndex - 1;
                    const remainingDistance = calculateTotalDistance(
                        routeCoordinates.slice(currentRouteIndex)
                    );
                    const remainingTimeHours = remainingDistance / 1000 / navigationSpeed;
                    const remainingTimeMinutes = Math.ceil(remainingTimeHours * 60);
                    
                    document.getElementById('routeRemainingTime').textContent = 
                        remainingTimeMinutes > 1 ? 
                            `Remaining: ~${remainingTimeMinutes} minutes` : 
                            `Remaining: <1 minute`;
                }
                
                // Calculate distance for delay
                const distance = calculateDistance(
                    currentPoint.lat, currentPoint.lng,
                    nextPoint.lat, nextPoint.lng
                );
                
                // Time to travel this segment at the given speed
                // Speed in km/h, distance in meters
                const speedInMetersPerSecond = navigationSpeed * 1000 / 3600; // Convert km/h to m/s
                const timeMs = (distance / speedInMetersPerSecond) * 1000; // Time in milliseconds
                
                // For demo purposes, we'll speed up the simulation but keep it proportional to distance
                const simulationFactor = 0.1; // 10x speed for demo
                const moveDelay = Math.max(100, timeMs * simulationFactor); // Minimum 100ms for visual smoothness
                
                console.log(`Moving ${distance.toFixed(2)}m, delay: ${moveDelay.toFixed(0)}ms`);
                
                // Move to next point after calculated time delay
                currentRouteIndex++;
                navigationInterval = setTimeout(simulateTruckMovement, moveDelay);
            };
            
            // Start the simulation
            simulateTruckMovement();
        }
        
        // Calculate total distance of a path
        function calculateTotalDistance(points) {
            let totalDistance = 0;
            for (let i = 0; i < points.length - 1; i++) {
                totalDistance += calculateDistance(
                    points[i].lat, points[i].lng,
                    points[i+1].lat, points[i+1].lng
                );
            }
            return totalDistance;
        }
        
        // Pause ongoing navigation
        function pauseNavigation() {
            if (navigationInterval) {
                clearTimeout(navigationInterval);
                navigationInterval = null;
            }
            
            document.getElementById('startNavigation').style.display = 'inline-block';
            document.getElementById('pauseNavigation').style.display = 'none';
        }
        
        // Stop navigation and reset
        function stopNavigation() {
            isNavigating = false;
            if (navigationInterval) {
                clearTimeout(navigationInterval);
                navigationInterval = null;
            }
            
            // Reset navigation controls but don't clear destination
            document.getElementById('startNavigation').style.display = routeCoordinates.length > 0 ? 'inline-block' : 'none';
            document.getElementById('pauseNavigation').style.display = 'none';
            document.getElementById('stopNavigation').style.display = 'none';
            document.getElementById('navigationProgress').style.display = 'none';
            
            // Re-enable location tracking but keep truck at current position
            startTracking();
        }
        
        // Helper function to calculate distance between points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const 1 = lat1 * Math.PI/180;
            const 2 = lat2 * Math.PI/180;
            const  = (lat2-lat1) * Math.PI/180;
            const  = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(/2) * Math.sin(/2) +
                    Math.cos(1) * Math.cos(2) *
                    Math.sin(/2) * Math.sin(/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // in meters
        }
        
        // Clear destination with updated function to clear instructions
        function clearDestination() {
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }
            
            document.getElementById('destinationInfo').style.display = 'none';
            document.getElementById('clearDestination').style.display = 'none';
            document.getElementById('route-instructions-container').style.display = 'none';
            document.getElementById('startNavigation').style.display = 'none';
        }

        // Set destination button
        document.getElementById('setDestination').addEventListener('click', function() {
            const destinationModal = new bootstrap.Modal(document.getElementById('setDestinationModal'));
            destinationModal.show();
        });
        
        // Clear destination button
        document.getElementById('clearDestination').addEventListener('click', clearDestination);
        
        // Save destination
        document.getElementById('saveDestination').addEventListener('click', function() {
            const address = document.getElementById('destinationAddress').value;
            const type = document.getElementById('destinationType').value;
            
            if (!address) {
                alert('Please enter a destination address');
                return;
            }
            
            // In a real app, you would use a geocoding service to convert address to coordinates
            // For this demo, we'll set a random nearby location
            if (currentLocationMarker) {
                const currentPos = currentLocationMarker.getLatLng();
                // Add some random offset to simulate a nearby location
                const lat = currentPos.lat + (Math.random() - 0.5) * 0.01;
                const lng = currentPos.lng + (Math.random() - 0.5) * 0.01;
                
                // Set the destination with the entered address as the name
                setDestination(lat, lng, address);
                
                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('setDestinationModal')).hide();
            } else {
                alert('Your current location is not available. Please enable location sharing first.');
            }
        });

        // Initialize page
        window.addEventListener('load', function() {
            // Start tracking if active
            if (document.getElementById('statusToggle').checked) {
                startTracking();
            }

            // Add map click event to quickly set destination
            map.on('click', function(e) {
                if (currentLocationMarker) {
                    const confirmation = confirm('Set this location as your destination?');
                    if (confirmation) {
                        setDestination(e.latlng.lat, e.latlng.lng, 'Selected Location');
                    }
                }
            });

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Add event listeners for navigation controls
            document.getElementById('startNavigation').addEventListener('click', startNavigation);
            document.getElementById('pauseNavigation').addEventListener('click', pauseNavigation);
            document.getElementById('stopNavigation').addEventListener('click', stopNavigation);
            
            // Debug message
            console.log("Navigation controls initialized");
            
            // Add event listeners for collection tasks
            document.querySelectorAll('.task-card').forEach(taskCard => {
                // Add data attribute for task ID if not already present
                if (!taskCard.hasAttribute('data-id')) {
                    const taskId = taskCard.querySelector('button[data-id]')?.getAttribute('data-id') || 
                                  Math.random().toString(36).substring(2, 9); // Generate random ID if none exists
                    taskCard.setAttribute('data-id', taskId);
                }
                
                // Add navigation buttons to each task card
                const cardBody = taskCard.querySelector('.card-body');
                const buttonGroup = cardBody.querySelector('.btn-group');
                
                // Only add the navigate button if it doesn't already exist
                if (!buttonGroup.querySelector('.navigate-to-task')) {
                    const navigateBtn = document.createElement('button');
                    navigateBtn.className = 'btn btn-sm btn-outline-info navigate-to-task';
                    navigateBtn.innerHTML = '<i class="bi bi-map"></i> Navigate';
                    buttonGroup.appendChild(navigateBtn);
                    
                    // Add click handler to navigate button
                    navigateBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const taskId = taskCard.getAttribute('data-id');
                        const barangayName = taskCard.querySelector('.card-title').textContent.trim();
                        navigateToTask(taskId, barangayName);
                    });
                }
            });
        });
        
        // Show notification when arrived at destination
        function showArrivalNotification() {
            // Create a toast notification for arrival
            const arrivalToast = document.createElement('div');
            arrivalToast.className = 'toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3';
            arrivalToast.setAttribute('role', 'alert');
            arrivalToast.setAttribute('aria-live', 'assertive');
            arrivalToast.setAttribute('aria-atomic', 'true');
            
            arrivalToast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        You have arrived at your destination!
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            document.body.appendChild(arrivalToast);
            const toast = new bootstrap.Toast(arrivalToast);
            toast.show();
            
            // Remove from DOM after hiding
            arrivalToast.addEventListener('hidden.bs.toast', function() {
                arrivalToast.remove();
            });
        }
        
        // Update the currently active task's status when navigation completes
        function updateActiveTaskStatus() {
            const activeTask = document.querySelector('.task-card.active');
            if (activeTask && currentDestinationTaskId) {
                // If the active task matches our current destination, mark as completed
                if (activeTask.getAttribute('data-id') === currentDestinationTaskId) {
                    const completeBtn = activeTask.querySelector('.complete-task');
                    if (completeBtn) {
                        // Trigger the complete action
                        completeBtn.click();
                    }
                }
            }
        }
        
        // Variable to track which task is linked to current destination
        let currentDestinationTaskId = null;
        
        // Function to navigate to a task's location
        function navigateToTask(taskId, barangayName) {
            // Store the task ID to reference when navigation completes
            currentDestinationTaskId = taskId;
            
            // First, find the task's actual coordinates
            // For demo purposes, we're generating random coordinates near the current location
            if (currentLocationMarker) {
                const currentPos = currentLocationMarker.getLatLng();
                
                // Use the task's actual coordinates if available in your backend
                // Here we're just creating random coordinates around the current position
                const destinationLat = currentPos.lat + (Math.random() - 0.5) * 0.01;
                const destinationLng = currentPos.lng + (Math.random() - 0.5) * 0.01;
                
                // Set the destination with the task's barangay name
                setDestination(destinationLat, destinationLng, `Collection: ${barangayName}`);
                
                // Start navigation automatically
                setTimeout(() => {
                    document.getElementById('startNavigation').click();
                }, 1000);
                
                // Highlight this task card
                document.querySelectorAll('.task-card').forEach(card => {
                    card.classList.remove('border-primary');
                });
                
                const taskCard = document.querySelector(`.task-card[data-id="${taskId}"]`);
                if (taskCard) {
                    taskCard.classList.add('border-primary');
                }
            }
        }
        
        // Global variable to store task locations for navigation
        const taskLocations = {
            {% for schedule in schedules %}
                "{{ schedule.id }}": {
                    name: "{{ schedule.barangay.name }}",
                    // Use actual coordinates from database if available
                    // Otherwise use these coordinates from the barangay's central point
                    lat: {{ schedule.latitude|default(schedule.barangay.latitude|default(14.676 + loop.index0 * 0.002)) }},
                    lng: {{ schedule.longitude|default(schedule.barangay.longitude|default(121.043 + loop.index0 * 0.003)) }},
                    address: "{{ schedule.address|default(schedule.barangay.name + ' Collection Area') }}",
                    status: "{{ schedule.status }}"
                },
            {% endfor %}
        };

        // Geocoding service to get accurate coordinates from addresses
        async function geocodeAddress(address) {
            try {
                // Using Nominatim OpenStreetMap geocoding service
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon),
                        display_name: data[0].display_name
                    };
                }
                return null;
            } catch (error) {
                console.error("Geocoding error:", error);
                return null;
            }
        }

        // Function to navigate to a task's location with improved accuracy
        async function navigateToTask(taskId, barangayName) {
            // Store the task ID to reference when navigation completes
            currentDestinationTaskId = taskId;
            
            // Show loading indicator
            const loadingToast = document.createElement('div');
            loadingToast.className = 'toast align-items-center text-bg-info border-0 position-fixed top-0 end-0 m-3';
            loadingToast.setAttribute('role', 'alert');
            loadingToast.setAttribute('aria-live', 'assertive');
            loadingToast.setAttribute('aria-atomic', 'true');
            loadingToast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Finding the best route to ${barangayName}...
                    </div>
                </div>
            `;
            document.body.appendChild(loadingToast);
            const toast = new bootstrap.Toast(loadingToast);
            toast.show();
            
            try {
                let destinationLat, destinationLng, locationName;
                
                // Use stored task locations if available
                if (taskLocations[taskId]) {
                    destinationLat = taskLocations[taskId].lat;
                    destinationLng = taskLocations[taskId].lng;
                    locationName = `Collection: ${taskLocations[taskId].name}`;
                    
                    // Try to geocode the address for more accuracy if we have one
                    if (taskLocations[taskId].address) {
                        const geocoded = await geocodeAddress(taskLocations[taskId].address + ", " + barangayName);
                        if (geocoded) {
                            destinationLat = geocoded.lat;
                            destinationLng = geocoded.lng;
                            locationName = `Collection: ${geocoded.display_name}`;
                            console.log("Using geocoded location:", geocoded);
                        }
                    }
                } else if (currentLocationMarker) {
                    // Fallback: Find the barangay's location using geocoding
                    const geocoded = await geocodeAddress(barangayName + ", Metro Manila, Philippines");
                    
                    if (geocoded) {
                        destinationLat = geocoded.lat;
                        destinationLng = geocoded.lng;
                        locationName = `Collection: ${geocoded.display_name}`;
                        console.log("Using geocoded barangay:", geocoded);
                    } else {
                        // Last resort fallback
                        const currentPos = currentLocationMarker.getLatLng();
                        destinationLat = currentPos.lat + 0.008; // Approximately 880m north
                        destinationLng = currentPos.lng + 0.006; // Approximately 660m east
                        locationName = `Collection: ${barangayName}`;
                        console.warn("Using fallback location calculation");
                    }
                } else {
                    toast.dispose();
                    loadingToast.remove();
                    alert("Cannot navigate: Your current location is not available.");
                    return;
                }
                
                // Set the destination with improved coordinates
                setDestination(destinationLat, destinationLng, locationName);
                
                // Store this location in our task locations for future reference
                if (!taskLocations[taskId]) {
                    taskLocations[taskId] = {
                        name: barangayName,
                        lat: destinationLat, 
                        lng: destinationLng,
                        address: locationName
                    };
                }
                
                // Start navigation automatically after route is calculated
                // We'll use an observer to wait for the route to be calculated
                const checkRouteExists = setInterval(() => {
                    if (routeCoordinates && routeCoordinates.length > 0) {
                        clearInterval(checkRouteExists);
                        setTimeout(() => {
                            document.getElementById('startNavigation').click();
                            toast.dispose();
                            loadingToast.remove();
                        }, 800);
                    }
                }, 100);
                
                // Set timeout in case routing takes too long
                setTimeout(() => {
                    clearInterval(checkRouteExists);
                    toast.dispose();
                    loadingToast.remove();
                }, 10000);
                
                // Highlight this task card
                document.querySelectorAll('.task-card').forEach(card => {
                    card.classList.remove('border-primary');
                });
                
                const taskCard = document.querySelector(`.task-card[data-id="${taskId}"]`);
                if (taskCard) {
                    taskCard.classList.add('border-primary');
                    
                    // Mark task as in-progress if scheduled
                    if (taskCard.classList.contains('pending')) {
                        const startTaskBtn = taskCard.querySelector('.start-task');
                        if (startTaskBtn) {
                            startTaskBtn.click();
                        }
                    }
                }
            } catch (error) {
                console.error("Navigation error:", error);
                toast.dispose();
                loadingToast.remove();
                
                // Show error message
                const errorToast = document.createElement('div');
                errorToast.className = 'toast align-items-center text-bg-danger border-0 position-fixed top-0 end-0 m-3';
                errorToast.setAttribute('role', 'alert');
                errorToast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Error finding route. Please try again.
                        </div>
                        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                document.body.appendChild(errorToast);
                const toast = new bootstrap.Toast(errorToast);
                toast.show();
                
                // Remove after hiding
                errorToast.addEventListener('hidden.bs.toast', function() {
                    errorToast.remove();
                });
            }
        }
        
        // Function to update the route line with proper navigation
        function updateRoute() {
            if (!currentLocationMarker || !destinationMarker) return;
            
            const start = currentLocationMarker.getLatLng();
            const end = destinationMarker.getLatLng();
            
            // Remove existing route if any
            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }
            
            // Create a new route using Leaflet Routing Machine with improved options
            routeControl = L.Routing.control({
                waypoints: [
                    L.latLng(start.lat, start.lng),
                    L.latLng(end.lat, end.lng)
                ],
                routeWhileDragging: false,
                addWaypoints: false,
                createMarker: function() { return null; }, // Don't create markers, we already have them
                lineOptions: {
                    styles: [
                        {color: '#3388ff', opacity: 0.8, weight: 5},
                        {color: 'white', opacity: 0.3, weight: 8}
                    ]
                },
                show: false, // Don't show the default instructions panel
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving',
                    suppressDemoServerWarning: true
                })
            }).addTo(map);
            
            // Listen for route found event to get instructions
            routeControl.on('routesfound', function(e) {
                const routes = e.routes;
                const route = routes[0]; // Get the first route
                
                // Store route coordinates for navigation simulation
                routeCoordinates = route.coordinates || [];
                console.log("Route found with", routeCoordinates.length, "coordinates");
                currentRouteIndex = 0;
                
                // Calculate ETA
                const distanceInMeters = route.summary.totalDistance;
                const distanceText = distanceInMeters > 1000 ? 
                    `${(distanceInMeters / 1000).toFixed(1)} km` : 
                    `${Math.round(distanceInMeters)} m`;
                
                const timeInSeconds = route.summary.totalTime;
                const timeInMinutes = Math.round(timeInSeconds / 60);
                const etaText = timeInMinutes > 60 ? 
                    `${Math.floor(timeInMinutes / 60)} hr ${timeInMinutes % 60} min` : 
                    `${timeInMinutes} min`;
                
                document.getElementById('destinationEta').textContent = `${distanceText} (ETA: ${etaText})`;
                
                // Extract and display turn-by-turn instructions
                const instructions = route.instructions || [];
                displayRouteInstructions(instructions);
                
                // Show navigation button once route is calculated
                document.getElementById('startNavigation').style.display = 'inline-block';
            });
            
            // Handle routing errors
            routeControl.on('routingerror', function(e) {
                console.error('Routing error:', e);
                showToast('Error finding route. Using direct route instead.', 'Routing Error');
                
                // Create a simple direct route if routing fails
                createDirectRoute(start, end);
            });
        }
        
        // Create a simple direct route when routing service fails
        function createDirectRoute(start, end) {
            // Generate a simplified path with just start and end
            routeCoordinates = [
                { lat: start.lat, lng: start.lng },
                { lat: end.lat, lng: end.lng }
            ];
            
            // Draw a simple line
            if (routeLine) {
                map.removeLayer(routeLine);
            }
            
            routeLine = L.polyline([
                [start.lat, start.lng],
                [end.lat, end.lng]
            ], {
                color: '#3388ff',
                weight: 5,
                opacity: 0.7
            }).addTo(map);
            
            // Calculate straight-line distance
            const distance = calculateDistance(start.lat, start.lng, end.lat, end.lng);
            const distanceText = distance > 1000 ? 
                `${(distance / 1000).toFixed(1)} km` : 
                `${Math.round(distance)} m`;
            
            // Estimate time (assuming 30 km/h average speed)
            const timeInMinutes = Math.round((distance / 1000) / 30 * 60);
            const etaText = timeInMinutes > 60 ? 
                `${Math.floor(timeInMinutes / 60)} hr ${timeInMinutes % 60} min` : 
                `${timeInMinutes} min`;
            
            document.getElementById('destinationEta').textContent = `${distanceText} (ETA: ~${etaText})`;
            
            // Create simplified instructions
            displayRouteInstructions([
                { 
                    type: 'Head', 
                    text: 'Head toward destination', 
                    distance: distance 
                },
                { 
                    type: 'DestinationReached', 
                    text: 'Arrive at destination',
                    distance: 0
                }
            ]);
            
            // Show navigation button
            document.getElementById('startNavigation').style.display = 'inline-block';
        }

        // Helper function to show toast messages
        function showToast(message, title = 'Notification') {
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-bg-primary border-0 position-fixed bottom-0 end-0 m-3';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}:</strong> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            document.body.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            
            // Remove from DOM after hiding
            toastEl.addEventListener('hidden.bs.toast', function() {
                toastEl.remove();
            });
        }

        // ...existing code...
    </script>

    <!-- Update the task cards to be clickable for navigation -->
    <style>
        /* ...existing styles... */
        
        .task-card {
            /* ...existing styles... */
            cursor: pointer;
            position: relative;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .task-card.border-primary {
            border: 1px solid #0d6efd !important;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        /* Add styling for task navigation button */
        .navigate-to-task {
            margin-left: 5px;
        }
    </style>
</body>
</html>
